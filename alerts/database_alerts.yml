groups:
- name: database_alerts
  rules:
  # Database Connection Alerts
  - alert: HighDatabaseConnections
    expr: pg_stat_activity_count{job="postgresql"} > 100
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High number of database connections"
      description: "There are more than 100 connections to PostgreSQL for over 5 minutes"

  - alert: CriticalDatabaseConnections
    expr: pg_stat_activity_count{job="postgresql"} > 150
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical number of database connections"
      description: "There are more than 150 connections to PostgreSQL for over 2 minutes"

  # Database Disk Space Alerts
  - alert: LowDatabaseDiskSpace
    expr: pg_database_size_bytes / pg_settings_setting_bytes{name="max_connections"} > 0.85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Low database disk space"
      description: "Database is using more than 85% of allocated disk space for over 5 minutes"

  # Database CPU Usage
  - alert: HighDatabaseCpuUsage
    expr: rate(process_cpu_seconds_total{job="postgresql"}[5m]) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High database CPU usage"
      description: "Database is using more than 80% of CPU for over 5 minutes"

  # Database Memory Usage
  - alert: HighDatabaseMemoryUsage
    expr: process_resident_memory_bytes{job="postgresql"} / container_memory_limit_bytes > 0.85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High database memory usage"
      description: "Database is using more than 85% of allocated memory for over 5 minutes"

  # Slow Queries
  - alert: SlowQueries
    expr: pg_stat_activity_max_tx_duration{datname!~"template.*|postgres"} > 300
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Slow database queries detected"
      description: "Queries are taking more than 5 minutes to execute"

  # Dead Tuples (tables needing vacuum)
  - alert: HighDeadTuples
    expr: pg_stat_user_tables_n_dead_tup > 10000
    for: 30m
    labels:
      severity: warning
    annotations:
      summary: "High number of dead tuples"
      description: "Tables have more than 10,000 dead tuples for over 30 minutes, consider running VACUUM"

  # Replication Lag
  - alert: HighReplicationLag
    expr: pg_replication_lag_bytes > 100000000
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High replication lag"
      description: "Replication lag is more than 100MB for over 5 minutes"