groups:
- name: backend_alerts
  rules:
  # API Response Time Alerts
  - alert: HighApiResponseTime
    expr: histogram_quantile(0.95, sum(rate(api_request_duration_seconds_bucket{job="backend"}[5m])) by (le, endpoint)) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High API response time on {{ $labels.endpoint }}"
      description: "95th percentile response time is above 2 seconds for endpoint {{ $labels.endpoint }} over the last 5 minutes"

  - alert: CriticalApiResponseTime
    expr: histogram_quantile(0.95, sum(rate(api_request_duration_seconds_bucket{job="backend"}[5m])) by (le, endpoint)) > 5
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical API response time on {{ $labels.endpoint }}"
      description: "95th percentile response time is above 5 seconds for endpoint {{ $labels.endpoint }} over the last 2 minutes"

  # API Error Rate Alerts
  - alert: HighErrorRate
    expr: sum(rate(api_http_requests_total{status=~"5.."}[5m])) by (endpoint) / sum(rate(api_http_requests_total[5m])) by (endpoint) > 0.05
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High error rate on {{ $labels.endpoint }}"
      description: "Error rate is above 5% for endpoint {{ $labels.endpoint }} over the last 5 minutes"

  - alert: CriticalErrorRate
    expr: sum(rate(api_http_requests_total{status=~"5.."}[5m])) by (endpoint) / sum(rate(api_http_requests_total[5m])) by (endpoint) > 0.1
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical error rate on {{ $labels.endpoint }}"
      description: "Error rate is above 10% for endpoint {{ $labels.endpoint }} over the last 2 minutes"

  # Service Health Check
  - alert: ApiServiceDown
    expr: up{job="backend"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "API Service is down"
      description: "The backend API service has been down for more than 1 minute"

  # Task Queue Alerts
  - alert: LongTaskQueueBacklog
    expr: celery_tasks_queued > 100
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Long task queue backlog"
      description: "More than 100 tasks are queued for over 10 minutes"

  # Memory Usage
  - alert: HighMemoryUsage
    expr: process_resident_memory_bytes{job="backend"} / container_memory_limit_bytes > 0.85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage in API service"
      description: "API service is using more than 85% of allocated memory for over 5 minutes"

  # CPU Usage
  - alert: HighCpuUsage
    expr: rate(process_cpu_seconds_total{job="backend"}[5m]) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage in API service"
      description: "API service is using more than 80% of CPU for over 5 minutes"